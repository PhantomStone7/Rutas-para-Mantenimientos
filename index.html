<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ruta de Entregas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .delivered { background-color: green; color: white; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        var map = L.map('map', { zoomControl: true }).setView([13.3103, -87.1848], 12);
        
        L.tileLayer('https://{s}.tile.jawg.io/jawg-sunny/{z}/{x}/{y}{r}.png?access-token=nvyWYYOXIkVSjIb3dUHvOzMiPkhJSlcoiKcwnpRNDyJ8d24l3H4BNlAvODieirpq', {
            attribution: '&copy; <a href="https://www.jawg.io">Jawg Maps</a> contributors'
        }).addTo(map);

        var puntos = [
          { coords: [13.320078401359323, -87.20453824017038], name: "variedades santiago" },
            { coords: [13.309186868220195, -87.18807099559378], name: "uno y pronto choluteca" },
            { coords: [13.308986862961593, -87.18946209462824], name: "uth" },
            { coords: [13.304566121126554, -87.1921108326764], name: "ultramotor y motomundo jetstereo" },
            { coords: [13.30838422965593, -87.17959339397703], name: "tienda lee" },
            { coords: [13.296625669471101, -87.17896157757127], name: "texaco las brisas" },
            { coords: [13.312917422168844, -87.17691814447033], name: "sycom" },
            { coords: [13.301349619035546, -87.19384124336233], name: "la colonia 45" },
            { coords: [13.309728520890996, -87.18097765352705], name: "la colonia" },
            { coords: [13.312033971453074, -87.17478354844549], name: "super repuesto" },
            { coords: [13.30724214958086, -87.18724437208469], name: "suministros" },
            { coords: [113.315497517300532, -87.1665388542927], name: "vida abundante" },
            { coords: [13.318630467447472, -87.15823917011899], name: "puma periferico" },
            { coords: [13.30979563717851, -87.18248224436243], name: "popeyes" },
            { coords: [13.312329010710961, -87.17390582111744], name: "pinturas americanas" },
            { coords: [13.305910748984633, -87.19175454354236], name: "nippon y crm" },
            { coords: [13.304156248309653, -87.19479556595552], name: "molineros " },
            { coords: [13.334667599725522, -87.13432796195255], name: "mercadito popular" },
            { coords: [13.310134433214989, -87.18102813221013], name: "bombos" },
            { coords: [13.309906423034073, -87.18621532927763], name: "bonillantas" },
            { coords: [13.308868531028057, -87.18769591882806], name: "lth" },
            { coords: [13.316774927868563, -87.19954177087065], name: "llantilandia" },
            { coords: [13.309828487874412, -87.18046098813262], name: "central de mangueras" },
            { coords: [13.308972376279025, -87.18570413561336], name: "gako kids " },
            { coords: [13.308446790844387, -87.17865758440065], name: "puma roady" },
            { coords: [13.304273285546726, -87.19314846318932], name: "la curacao" },
            { coords: [13.309540832991571, -87.18526208116926], name: "kfc" },
            { coords: [13.298321476914838, -87.18925404692209], name: "el milenio" },
            { coords: [13.311300166982974, -87.1862843048648], name: "centro dermatologico" },
            { coords: [13.30292290871217, -87.19564504329477], name: "el compadre " },
            { coords: [13.29884155056185, -87.19653670103429], name: "el carreto" },
            { coords: [13.309690712510754, -87.18927650783498], name: "jetstereo riu" },
            { coords: [13.307704068123682, -87.18617653943147], name: "hotel villa " },
            { coords: [13.309958837535998, -87.18800198573201], name: "hotel la fuente" },
            { coords: [13.313936940778602, -87.19158325843475], name: "hotel guali" },
            { coords: [13.294667632512795, -87.17897655592039], name: "hotel casa real" },
            { coords: [13.301515460199289, -87.19764903380853], name: "herco centro" },
            { coords: [13.308437480729875, -87.17868508653254], name: "puma roady" },
            { coords: [13.30396517736062, -87.19366839895568], name: "gallo mas gallo" },      
            { coords: [13.304223602655616, -87.18123252915957], name: "sonis" },
            { coords: [113.313697670272903, -87.15815347196354], name: "del valle" },
            { coords: [13.291290526166424, -87.17810792958718], name: "cyme" },
            { coords: [13.289584095036599, -87.17912248991044], name: "copa shel" },
            { coords: [13.30827111573449, -87.18972263512725], name: "centrho " },
            { coords: [13.315384354689318, -87.16638263027015], name: "vida abundante" },
            { coords: [13.305699762573916, -87.19323004850843], name: "Almacenes del sur" },
        ];
   
        var markers = puntos.map((point, index) => {
            var marker = L.marker(point.coords).addTo(map);
            marker.bindPopup(`
                <label for='locationName${index}'>Nombre del Lugar:</label>
                <input type='text' id='locationName${index}' value='${point.name}' oninput='updateName(${index}, this.value)'><br>
                <button onclick='markDelivered(${index})'>Marcar como hecho</button>
            `);
            return marker;
        });

        function updateName(index, name) {
            puntos[index].name = name;
        }

        function markDelivered(index) {
            if (markers[index]) {
                map.removeLayer(markers[index]);
                markers[index] = null;
                updateRoute();
            }
        }

        var userMarker = null;
        var userPosition = null;
        var routeLine = null;

        function updateRoute() {
            if (!userPosition) return;
            var remainingPoints = markers.filter(marker => marker !== null).map(marker => marker.getLatLng());
            if (remainingPoints.length === 0) return;
            
            var coordinates = [[userPosition[1], userPosition[0]], ...remainingPoints.map(p => [p.lng, p.lat])].join(';');
            var osrmRouteUrl = `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`;
            
            fetch(osrmRouteUrl)
                .then(response => response.json())
                .then(data => {
                    if (routeLine) {
                        map.removeLayer(routeLine);
                    }
                    routeLine = L.polyline(data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]), {color: 'blue', weight: 5}).addTo(map);
                })
                .catch(error => console.error("Error obteniendo la ruta: ", error));
        }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(position => {
                userPosition = [position.coords.latitude, position.coords.longitude];
                if (userMarker) {
                    userMarker.setLatLng(userPosition);
                } else {
                    userMarker = L.circle(userPosition, {radius: 50, color: 'red', fillColor: 'red', fillOpacity: 0.5}).addTo(map);
                }

                updateRoute();
            }, error => console.error("Error obteniendo la ubicación: ", error), { enableHighAccuracy: true });
        } else {
            alert("Geolocalización no soportada");
        }
    </script>
</body>
</html>
