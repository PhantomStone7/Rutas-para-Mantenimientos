<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ruta de Entregas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .delivered { background-color: green; color: white; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        var map = L.map('map', { zoomControl: true }).setView([13.3103, -87.1848], 12);
        
        L.tileLayer('https://{s}.tile.jawg.io/jawg-sunny/{z}/{x}/{y}{r}.png?access-token=nvyWYYOXIkVSjIb3dUHvOzMiPkhJSlcoiKcwnpRNDyJ8d24l3H4BNlAvODieirpq', {
            attribution: '&copy; <a href="https://www.jawg.io">Jawg Maps</a> contributors'
        }).addTo(map);

        var puntos = [
           { coords: [13.30310116029368, -87.19387697651054], name: "la nueva moda" },
            { coords: [13.290749421823442, -87.15309458999883], name: "areca" },
            { coords: [13.310240956757712, -87.18021354003947], name: "Basilios" },
            { coords: [13.308837062937585, -87.19349044836355], name: "body perfect" },
            { coords: [13.310167103156836, -87.18099055007617], name: "bombos" },
            { coords: [13.308806121021858, -87.18848107057312], name: "Cadeca" },
            { coords: [13.316530254033363, -87.16551150164345], name: "castor cafe" },
            { coords: [13.310499497257041, -87.17719530031273], name: "clinisur" },
            { coords: [13.296230086841371, -87.19183042762336], name: "monjaras" },
            { coords: [13.289584842041123, -87.1791237599715], name: "Shell" },
            { coords: [113.303972851134045, -87.19443390780113], name: "de todo" },
            { coords: [13.304250429994095, -87.18122463981291], name: "sonis" },
            { coords: [13.303579845163494, -87.19393821788651], name: "farmacia siman" },
            { coords: [13.30025602191674, -87.19389122580473], name: "el ahorro " },
            { coords: [13.303523726318502, -87.188184037455], name: "el ahorro 113" },
            { coords: [13.31828775911962, -87.15951755345522], name: "ferromax" },
            { coords: [13.309939939943206, -87.18968486672118], name: "Home Gallery, Jetstereo " },
            { coords: [13.308028309625765, -87.1933685207138], name: "Hotel Baruch" },
            { coords: [13.307309192953243, -87.18677507933813], name: "hotel los angeles" },
            { coords: [13.301268258213142, -87.19279773824591], name: "infocell" },
            { coords: [13.30312059953076, -87.18960866715264], name: "Insa" },
            { coords: [13.309096937527347, -87.18512922980095], name: "jays" },
            { coords: [13.30464531501344, -87.19189103547536], name: "Jetstereo" },
            { coords: [13.308672741501658, -87.18678603779846], name: "La curacao cash " },
            { coords: [13.300576211597747, -87.19405207795964], name: "Villatoro" },
            { coords: [13.316797432461488, -87.19956642194747], name: "llantilandia" },
            { coords: [13.309238729650366, -87.18657738012419], name: "macdel" },
            { coords: [13.304945152153511, -87.18598853436389], name: "mi pollo" },
            { coords: [13.317477293832347, -87.16079638308703], name: "moto repuestos" },
            { coords: [13.310260965453644, -87.18437828698265], name: "promaco" },
            { coords: [13.31638222005326, -87.16185682173594], name: "pollisimo" },
            { coords: [13.304241288246777, -87.19243083681901], name: "puma chol" },
            { coords: [13.311753916046333, -87.17464887221162], name: "rendillantas" },
            { coords: [13.29499659480619, -87.18491218110528], name: "san jose obrero" },
            { coords: [13.294069135518418, -87.15395400231478], name: "super oferta" },
            { coords: [13.295357442631982, -87.191172953918], name: "carbajal" },
            { coords: [13.30194953852486, -87.19832033336382], name: "tblue" },
            { coords: [13.309632106656487, -87.18007026966168], name: "tapachula" },
            { coords: [13.308392969788109, -87.17961419455098], name: "tienda lee" },
            { coords: [13.301965129693652, -87.19456479282931], name: "tienda robert" },
            { coords: [13.30411094004116, -87.19342677515662], name: "m&m" },
            { coords: [13.309970133863892, -87.16003065975406], name: "Unicah " },
            { coords: [13.304542704959394, -87.19211162986258], name: "vento" },
            
        ];
   
        var markers = puntos.map((point, index) => {
            var marker = L.marker(point.coords).addTo(map);
            marker.bindPopup(`
                <label for='locationName${index}'>Nombre del Lugar:</label>
                <input type='text' id='locationName${index}' value='${point.name}' oninput='updateName(${index}, this.value)'><br>
                <button onclick='markDelivered(${index})'>Marcar como hecho</button>
            `);
            return marker;
        });

        function updateName(index, name) {
            puntos[index].name = name;
        }

        function markDelivered(index) {
            if (markers[index]) {
                map.removeLayer(markers[index]);
                markers[index] = null;
                updateRoute();
            }
        }

        var userMarker = null;
        var userPosition = null;
        var routeLine = null;

        function updateRoute() {
            if (!userPosition) return;
            var remainingPoints = markers.filter(marker => marker !== null).map(marker => marker.getLatLng());
            if (remainingPoints.length === 0) return;
            
            var coordinates = [[userPosition[1], userPosition[0]], ...remainingPoints.map(p => [p.lng, p.lat])].join(';');
            var osrmRouteUrl = `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`;
            
            fetch(osrmRouteUrl)
                .then(response => response.json())
                .then(data => {
                    if (routeLine) {
                        map.removeLayer(routeLine);
                    }
                    routeLine = L.polyline(data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]), {color: 'blue', weight: 5}).addTo(map);
                })
                .catch(error => console.error("Error obteniendo la ruta: ", error));
        }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(position => {
                userPosition = [position.coords.latitude, position.coords.longitude];
                if (userMarker) {
                    userMarker.setLatLng(userPosition);
                } else {
                    userMarker = L.circle(userPosition, {radius: 50, color: 'red', fillColor: 'red', fillOpacity: 0.5}).addTo(map);
                }

                updateRoute();
            }, error => console.error("Error obteniendo la ubicación: ", error), { enableHighAccuracy: true });
        } else {
            alert("Geolocalización no soportada");
        }
    </script>
</body>
</html>
