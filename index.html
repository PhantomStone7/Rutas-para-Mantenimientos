<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ruta de Entregas</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100vw; }
        .delivered { background-color: green; color: white; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        var map = L.map('map', { zoomControl: true }).setView([13.3103, -87.1848], 12);
        
        L.tileLayer('https://{s}.tile.jawg.io/jawg-sunny/{z}/{x}/{y}{r}.png?access-token=nvyWYYOXIkVSjIb3dUHvOzMiPkhJSlcoiKcwnpRNDyJ8d24l3H4BNlAvODieirpq', {
            attribution: '&copy; <a href="https://www.jawg.io">Jawg Maps</a> contributors'
        }).addTo(map);

        var puntos = [
           { coords: [13.31554776675325, -87.16463242416833], name: "alutech" },
            { coords: [13.309491447458369, -87.18228539481385], name: "autorepuestos" },
            { coords: [13.308986862961593, -87.18946209462824], name: "uth" },
            { coords: [13.309663649018724, -87.18948876748118], name: "basilios" },
            { coords: [13.312613240388156, -87.17234373260625], name: "cafeteria el mana" },
            { coords: [13.308706072554962, -87.18672418622597], name: "cz mobile" },
            { coords: [13.30274368622744, -87.18383465749179], name: "puma aterrizaje" },
            { coords: [13.316948896723149, -87.16221988196838], name: "jardines y piscinas" },
            { coords: [13.292122797037443, -87.17809099449832], name: "jicaral" },
            { coords: [13.304528710416431, -87.17858790703059], name: "mados" },
            { coords: [13.31212766624159, -87.1736884049477], name: "mega fardos platinum" },
            { coords: [13.312926325930805, -87.17129594984158], name: "mercadito 24 7" },
            { coords: [13.30963828383665, -87.18706615055319], name: "moto repuestos" },
            { coords: [13.304725291301184, -87.19738686988622], name: "oftalmosur" },
            { coords: [13.316812498061037, -87.16245123004347], name: "pagsa" },
            { coords: [13.310372013735906, -87.18418625977932], name: "promaco" },
            { coords: [13.309118620357532, -87.1881218417244], name: "pronto " },
            { coords: [13.305679378447305, -87.19005610400099], name: "punto farma" },
            { coords: [13.309629885429423, -87.19090435770828], name: "pupusas del valle" },
            { coords: [13.30403761808309, -87.18216925117052], name: "blue agave" },
            { coords: [13.307988093041613, -87.18816720413383], name: "super empaques" },
        ];
   
        var markers = puntos.map((point, index) => {
            var marker = L.marker(point.coords).addTo(map);
            marker.bindPopup(`
                <label for='locationName${index}'>Nombre del Lugar:</label>
                <input type='text' id='locationName${index}' value='${point.name}' oninput='updateName(${index}, this.value)'><br>
                <button onclick='markDelivered(${index})'>Marcar como hecho</button>
            `);
            return marker;
        });

        function updateName(index, name) {
            puntos[index].name = name;
        }

        function markDelivered(index) {
            if (markers[index]) {
                map.removeLayer(markers[index]);
                markers[index] = null;
                updateRoute();
            }
        }

        var userMarker = null;
        var userPosition = null;
        var routeLine = null;

        function updateRoute() {
            if (!userPosition) return;
            var remainingPoints = markers.filter(marker => marker !== null).map(marker => marker.getLatLng());
            if (remainingPoints.length === 0) return;
            
            var coordinates = [[userPosition[1], userPosition[0]], ...remainingPoints.map(p => [p.lng, p.lat])].join(';');
            var osrmRouteUrl = `https://router.project-osrm.org/route/v1/driving/${coordinates}?overview=full&geometries=geojson`;
            
            fetch(osrmRouteUrl)
                .then(response => response.json())
                .then(data => {
                    if (routeLine) {
                        map.removeLayer(routeLine);
                    }
                    routeLine = L.polyline(data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]), {color: 'blue', weight: 5}).addTo(map);
                })
                .catch(error => console.error("Error obteniendo la ruta: ", error));
        }

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(position => {
                userPosition = [position.coords.latitude, position.coords.longitude];
                if (userMarker) {
                    userMarker.setLatLng(userPosition);
                } else {
                    userMarker = L.circle(userPosition, {radius: 50, color: 'red', fillColor: 'red', fillOpacity: 0.5}).addTo(map);
                }

                updateRoute();
            }, error => console.error("Error obteniendo la ubicación: ", error), { enableHighAccuracy: true });
        } else {
            alert("Geolocalización no soportada");
        }
    </script>
</body>
</html>
